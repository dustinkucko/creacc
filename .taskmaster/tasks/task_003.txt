# Task ID: 3
# Title: Storage Abstraction Layer
# Status: pending
# Dependencies: None
# Priority: medium
# Description: Create a pluggable storage adapter interface and a local filesystem implementation to support POSIX-correct git repo I/O in dev/test.
# Details:
- Files: `src/storage/{interface.ts,local.ts,block-volume.ts,network-fs.ts,index.ts}`.
- Define `StorageAdapter` with methods: `readFile, writeFile, mkdirp, stat, exists, readdir, unlink, rename, lock(path, fn), fsync(path)` using Promises.
- Implement `local.ts` using `fs/promises` and `flock`-like advisory locking via `proper-lockfile` or simple lockfiles under `.locks` as placeholder; ensure atomic writes: write temp file + `rename`.
- Provide base paths config (e.g., `/srv/git` for repos, `/var/tmp/creacc` for worktrees in dev).
- Index exports `createStorageAdapter(config)` returning the appropriate impl; stubs for `block-volume` and `network-fs` with TODOs but compliant interfaces.
- Ensure Unicode NFC normalization on all path inputs using identity.normalizePath before filesystem ops.

# Test Strategy:
- Unit tests: mock temp directory, verify atomic write then rename; lock executes critical section exclusively; NFC normalization applied; mkdirp idempotency.
- Integration: write/read binary round trip; concurrent lock contention with timing asserts.

# Subtasks:
## 1. Review storage requirements and existing identity utilities [pending]
### Dependencies: None
### Description: Read PRD, architecture, and identity modules to capture storage adapter expectations.
### Details:
Inspect docs and current identity helpers to ensure StorageAdapter design matches normalization and POSIX semantics.

## 2. Define StorageAdapter TypeScript interface [pending]
### Dependencies: 3.1
### Description: Author interface.ts with required async methods and shared types.
### Details:
Create interface signature covering read/write, locking, fsync, and error semantics plus exported types for stat metadata.

## 3. Add path normalization wrapper utilities [pending]
### Dependencies: 3.1, 3.2
### Description: Integrate NFC normalization before filesystem access.
### Details:
Import identity.normalizePath, wrap adapter paths, and propagate normalized values consistently across all operations.

## 4. Implement local filesystem adapter with atomic writes and locking [pending]
### Dependencies: 3.2, 3.3
### Description: Build local.ts using fs/promises with atomic rename and advisory locks.
### Details:
Use temp-file write+rename for writeFile, manage lockfiles under .locks, ensure mkdirp/stat semantics, and call fsync when required.

## 5. Create block-volume and network-fs adapter stubs [pending]
### Dependencies: 3.2
### Description: Provide placeholder modules matching the interface with TODO guidance.
### Details:
Implement compliant classes exporting unimplemented methods that throw TODO errors, documenting future storage-specific behavior.

## 6. Implement storage adapter factory in index.ts [pending]
### Dependencies: 3.4, 3.5
### Description: Wire createStorageAdapter to return implementations per config.
### Details:
Parse adapter config, construct local adapter with base paths, and expose stubs for other types while validating options.

## 7. Draft unit and integration test scaffolding [pending]
### Dependencies: 3.4, 3.6
### Description: Set up test files covering adapter behaviors and concurrency cases.
### Details:
Create test suites for normalization, atomic writes, locking, and factory selection, including helper fixtures for temporary directories.

